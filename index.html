<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Fact Rumble</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
        }
        #container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        #current-user {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 15px;
        }
        /* User Selection */
        #user-selection {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            justify-content: center;
        }
        select, input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        #new-user-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        /* Stats */
        #stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
            flex-wrap: wrap;
            text-align: center;
        }
        #stats span {
            font-weight: bold;
            color: #2c3e50;
        }
        /* Buttons - General Styling */
        button {
            padding: 12px 24px; /* Slightly larger for touch screens */
            margin: 8px; /* Increased spacing */
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px; /* Softer corners */
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s; /* Add scale effect */
            font-size: 16px; /* Larger text for readability */
            min-width: 120px; /* Prevent buttons from shrinking too much */
        }
        button:hover {
            background-color: #2980b9;
            transform: scale(1.05); /* Slight grow on hover */
        }
        button.active {
            background-color: #e67e22;
            transform: scale(1.05); /* Stay scaled when active */
        }
        #reset-btn { background-color: #e74c3c; }
        #reset-btn:hover { background-color: #c0392b; }
        #clear-storage-btn { background-color: #e74c3c; }
        #clear-storage-btn:hover { background-color: #c0392b; }
        /* Operation and Group Selection */
        #operation-selection, #group-selection {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap on small screens */
            justify-content: center; /* Center buttons */
            gap: 15px; /* Consistent spacing */
            margin-bottom: 20px;
            padding: 10px;
            background: #eef2f7; /* Subtle background for visual grouping */
            border-radius: 8px;
            max-width: 100%; /* Prevent overflow */
        }
        #group-selection {
            display: none; /* Hidden by default, as before */
        }
        /* Game Area */
        #game-area {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #f9fbfc;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
        }
        #question {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
        }
        #answer {
            font-size: 40px;
            color: #000000;
            display: block;
        }
        #user-input {
            width: 120px;
            font-size: 16px;
            padding: 10px;
            text-align: center;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #feedback {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
            min-height: 24px;
        }
        #feedback.green { color: #27ae60; }
        #feedback.red { color: #c0392b; }
        /* Progress */
        #group-progress {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            background: #ecf0f1;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
            border: 1px solid #ddd;
        }
        .progress-fill {
            height: 100%;
            background: #2ecc71;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        /* Controls */
        #controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        details { margin: 15px 0; }
        summary {
            cursor: pointer;
            padding: 5px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        /* Media Query for Smaller Screens */
        @media (max-width: 600px) {
            button {
                padding: 10px 20px;
                font-size: 14px;
                min-width: 100px;
            }
            #operation-selection, #group-selection {
                gap: 10px;
                padding: 8px;
            }
            #stats {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Math Fact Rumble</h1>
        <div id="current-user">Current User: None</div>
        <div id="user-selection">
            <select id="user-select"><option value="" selected>Select a user</option></select>
            <button id="load-user-btn">Load User</button>
            <button id="add-user-btn">Add User</button>
        </div>
        <div id="new-user-input" style="display: none;">
            <input type="text" id="user-name" placeholder="Enter user name">
            <button id="save-name-btn">Save</button>
        </div>
        <div id="stats">
            <div>Total Mastered: <span id="mastery-count">0</span></div>
            <div>Operation Mastery: <span id="op-mastery">0/144</span></div>
            <div>Points: <span id="user-points">0</span> | Level: <span id="user-level">Novice</span> | Streak: <span id="streak-count">0</span></div>
        </div>
        <div id="operation-selection">
            <button id="addBtn">Addition</button>
            <button id="subBtn">Subtraction</button>
            <button id="mulBtn">Multiplication</button>
            <button id="divBtn">Division</button>
        </div>
        <div id="group-selection">
            <button class="group-btn" data-group="0">Base Facts</button>
            <button class="group-btn" data-group="1">Mid-Tier</button>
            <button class="group-btn" data-group="2">Higher Facts</button>
        </div>
        <div id="group-progress"></div>
        <div id="game-area">
            <div id="question"></div>
            <span id="answer"></span>
            <input type="number" id="user-input" style="display: none;">
            <div>
                <button id="coverBtn" style="display: none;">Cover</button>
                <button id="compareBtn" style="display: none;">Compare</button>
                <button id="nextBtn" style="display: none;">Next</button>
            </div>
            <div id="feedback">Select or add a user to start!</div>
        </div>
        <div id="controls">
            <button id="reset-btn">Reset Progress</button>
            <button id="clear-storage-btn">Clear Local Storage</button>
            <a href="#" id="summary-link">Mastery Summary</a>
            <a href="#" id="teacher-report-link">Teacher Report</a>
        </div>
        <div id="mastery-summary" class="modal">
            <div class="modal-content">
                <h2>Mastery Summary</h2>
                <div id="summary-content"></div>
                <button id="download-btn">Download Results</button>
                <button id="close-summary">Close</button>
            </div>
        </div>
        <div id="teacher-report" class="modal">
            <div class="modal-content">
                <h2>Teacher Report</h2>
                <div id="report-content"></div>
                <button id="download-report-btn">Download Report</button>
                <button id="close-report">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const facts = {
                addition: Array.from({ length: 144 }, (_, i) => {
                    const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                    return { q: `${a} + ${b}`, a: a + b, group: Math.floor((a - 1) / 3) };
                }),
                subtraction: Array.from({ length: 144 }, (_, i) => {
                    const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                    return { q: `${a + b} - ${b}`, a: a, group: Math.floor((a - 1) / 3) };
                }),
                multiplication: (() => {
                    const mulFacts = [];
                    for (let a = 1; a <= 12; a++) {
                        for (let b = 1; b <= 12; b++) {
                            let group;
                            if ([1, 2, 5, 10].includes(a)) group = 0; // Base Facts
                            else if ([3, 4].includes(a)) group = 1;   // Mid-Tier
                            else group = 2;                           // Higher Facts (6, 7, 8, 9)
                            mulFacts.push({ q: `${a} × ${b}`, a: a * b, group });
                        }
                    }
                    return mulFacts;
                })(),
                division: Array.from({ length: 144 }, (_, i) => {
                    const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                    return { q: `${a * b} ÷ ${b}`, a: a, group: Math.floor((a - 1) / 3) };
                })
            };

            const questionEl = document.getElementById("question");
            const answerEl = document.getElementById("answer");
            const userInput = document.getElementById("user-input");
            const feedbackEl = document.getElementById("feedback");
            const coverBtn = document.getElementById("coverBtn");
            const compareBtn = document.getElementById("compareBtn");
            const nextBtn = document.getElementById("nextBtn");
            const opMasteryEl = document.getElementById("op-mastery");
            const masteryCountEl = document.getElementById("mastery-count");
            const addBtn = document.getElementById("addBtn");
            const subBtn = document.getElementById("subBtn");
            const mulBtn = document.getElementById("mulBtn");
            const divBtn = document.getElementById("divBtn");
            const resetBtn = document.getElementById("reset-btn");
            const clearStorageBtn = document.getElementById("clear-storage-btn");
            const summaryLink = document.getElementById("summary-link");
            const teacherReportLink = document.getElementById("teacher-report-link");
            const masterySummary = document.getElementById("mastery-summary");
            const summaryContent = document.getElementById("summary-content");
            const closeSummaryBtn = document.getElementById("close-summary");
            const downloadBtn = document.getElementById("download-btn");
            const teacherReport = document.getElementById("teacher-report");
            const reportContent = document.getElementById("report-content");
            const closeReportBtn = document.getElementById("close-report");
            const downloadReportBtn = document.getElementById("download-report-btn");
            const userSelect = document.getElementById("user-select");
            const loadUserBtn = document.getElementById("load-user-btn");
            const addUserBtn = document.getElementById("add-user-btn");
            const newUserInput = document.getElementById("new-user-input");
            const userNameInput = document.getElementById("user-name");
            const saveNameBtn = document.getElementById("save-name-btn");
            const currentUserEl = document.getElementById("current-user");
            const groupSelection = document.getElementById("group-selection");
            const groupProgress = document.getElementById("group-progress");
            const userPointsEl = document.getElementById("user-points");
            const userLevelEl = document.getElementById("user-level");
            const streakCountEl = document.getElementById("streak-count");

            let currentFact = null, selectedOp = null, selectedGroup = null, currentUser = null;
            let mastery = { addition: {}, subtraction: {}, multiplication: {}, division: {} };
            let points = 0, streak = 0;

            const levels = [
                { name: "Novice", threshold: 0 },
                { name: "Mathlete", threshold: 100 },
                { name: "Champion", threshold: 300 },
                { name: "Legend", threshold: 500 }
            ];

            function populateUserDropdown() {
                const users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
                userSelect.innerHTML = '<option value="" selected>Select a user</option>';
                users.forEach(user => {
                    const option = document.createElement("option");
                    option.value = user;
                    option.textContent = user;
                    userSelect.appendChild(option);
                });
            }

            function loadUserData(username) {
                if (!username) return;
                currentUser = username;
                localStorage.setItem("mathFactRumbleCurrentUser", currentUser);
                currentUserEl.textContent = `Current User: ${currentUser}`;
                const userDataRaw = localStorage.getItem(`mathFactRumbleMastery_${currentUser}`);
                let userData;
                try {
                    userData = JSON.parse(userDataRaw) || {
                        mastery: { addition: {}, subtraction: {}, multiplication: {}, division: {} },
                        points: 0,
                        streak: 0
                    };
                } catch (e) {
                    console.error("Failed to parse user data:", e);
                    userData = { mastery: { addition: {}, subtraction: {}, multiplication: {}, division: {} }, points: 0, streak: 0 };
                }
                mastery = {
                    addition: userData.mastery.addition || {},
                    subtraction: userData.mastery.subtraction || {},
                    multiplication: userData.mastery.multiplication || {},
                    division: userData.mastery.division || {}
                };
                points = userData.points || 0;
                streak = userData.streak || 0;
                updateMasteryCount();
                updatePointsAndLevel();
                feedbackEl.textContent = "Pick an operation to start!";
            }

            function saveUserData() {
                if (currentUser) {
                    const dataToSave = { mastery, points, streak };
                    localStorage.setItem(`mathFactRumbleMastery_${currentUser}`, JSON.stringify(dataToSave));
                    console.log("Saved data for", currentUser, dataToSave);
                }
            }

            loadUserBtn.addEventListener("click", () => {
                const selectedUser = userSelect.value;
                if (selectedUser) loadUserData(selectedUser);
                else feedbackEl.textContent = "Please select a user!";
            });

            addUserBtn.addEventListener("click", () => {
                newUserInput.style.display = "flex";
                userNameInput.focus();
            });

            saveNameBtn.addEventListener("click", () => {
                const name = userNameInput.value.trim();
                if (name) {
                    let users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
                    if (!users.includes(name)) {
                        users.push(name);
                        localStorage.setItem("mathFactRumbleUsers", JSON.stringify(users));
                    }
                    loadUserData(name);
                    populateUserDropdown();
                    newUserInput.style.display = "none";
                    userNameInput.value = "";
                } else {
                    feedbackEl.textContent = "Please enter a name!";
                }
            });

            function getRandomFact() {
                if (!selectedOp || selectedGroup === null) {
                    feedbackEl.textContent = selectedOp ? "Pick a group to start!" : "Pick an operation to start!";
                    return null;
                }
                const groupFacts = facts[selectedOp].filter(f => f.group === selectedGroup);
                return groupFacts[Math.floor(Math.random() * groupFacts.length)];
            }

            function displayFact() {
                if (!currentUser) {
                    feedbackEl.textContent = "Select or add a user to start!";
                    return;
                }
                currentFact = getRandomFact();
                if (!currentFact) return;
                questionEl.textContent = currentFact.q;
                answerEl.textContent = currentFact.a;
                answerEl.style.display = "inline";
                userInput.style.display = "none";
                userInput.value = "";
                feedbackEl.textContent = "";
                coverBtn.style.display = "inline";
                compareBtn.style.display = "none";
                nextBtn.style.display = "none";
            }

            coverBtn.addEventListener("click", () => {
                if (!currentFact) return;
                answerEl.style.display = "none";
                userInput.style.display = "inline";
                coverBtn.style.display = "none";
                compareBtn.style.display = "inline";
                userInput.focus();
            });

            compareBtn.addEventListener("click", () => {
                console.log("Compare clicked", { currentFact, selectedOp });
                if (!currentFact || !selectedOp) {
                    feedbackEl.textContent = "Error: No fact or operation selected!";
                    return;
                }
                const userAnswer = parseInt(userInput.value);
                if (isNaN(userAnswer)) {
                    feedbackEl.textContent = "Please enter a number!";
                    return;
                }
                mastery[selectedOp][currentFact.q] = mastery[selectedOp][currentFact.q] || { attempts: 0, correct: 0, lastAttempt: null };
                mastery[selectedOp][currentFact.q].attempts++;
                mastery[selectedOp][currentFact.q].lastAttempt = new Date().toISOString();
                if (userAnswer === currentFact.a) {
                    mastery[selectedOp][currentFact.q].correct++;
                    points += 10;
                    streak++;
                    if (streak % 3 === 0) {
                        points += 20;
                        feedbackEl.textContent = `Streak ${streak}! +20 Bonus!`;
                        feedbackEl.classList.add("green");
                    } else {
                        feedbackEl.textContent = "You pinned that fact!";
                        feedbackEl.classList.add("green");
                    }
                    feedbackEl.classList.remove("red");
                } else {
                    feedbackEl.textContent = `Ouch! It’s ${currentFact.a}. Try again!`;
                    feedbackEl.classList.add("red");
                    feedbackEl.classList.remove("green");
                    streak = 0;
                }
                saveUserData();
                updateMasteryCount();
                updatePointsAndLevel();
                updateGroupProgress();
                compareBtn.style.display = "none";
                nextBtn.style.display = "inline";
                nextBtn.focus();
            });

            userInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter" && compareBtn.style.display === "inline") compareBtn.click();
            });

            nextBtn.addEventListener("click", displayFact);
            nextBtn.addEventListener("keypress", (e) => {
                if (e.key === "Enter") displayFact();
            });

            function updateMasteryCount() {
                if (!mastery || typeof mastery !== "object") {
                    mastery = { addition: {}, subtraction: {}, multiplication: {}, division: {} };
                }
                const totalMastered = Object.keys(mastery).reduce((sum, op) => {
                    return sum + Object.values(mastery[op] || {}).filter(m => m.correct >= 3).length;
                }, 0);
                masteryCountEl.textContent = totalMastered;
                const opMastered = selectedOp ? Object.values(mastery[selectedOp] || {}).filter(m => m.correct >= 3).length : 0;
                const totalFacts = selectedOp === "multiplication" ? (selectedGroup === 0 ? 48 : selectedGroup === 1 ? 24 : 48) : 144;
                opMasteryEl.textContent = `${opMastered}/${totalFacts}`;
            }

            function updatePointsAndLevel() {
                userPointsEl.textContent = points;
                streakCountEl.textContent = streak;
                const currentLevel = levels.reduce((prev, curr) => 
                    points >= curr.threshold ? curr : prev, levels[0]);
                userLevelEl.textContent = currentLevel.name;
            }

            function updateGroupProgress() {
                if (!selectedOp) return;
                let content = "";
                const groupCount = selectedOp === "multiplication" ? 3 : 4;
                const groupNames = selectedOp === "multiplication" ? 
                    ["Base Facts (1, 2, 5, 10)", "Mid-Tier (3, 4)", "Higher Facts (6, 7, 8, 9)"] : 
                    ["1-3", "4-6", "7-9", "10-12"];
                const factsPerGroup = selectedOp === "multiplication" ? [48, 24, 48] : [36, 36, 36, 36];
                for (let g = 0; g < groupCount; g++) {
                    const groupFacts = facts[selectedOp].filter(f => f.group === g);
                    const masteredInGroup = groupFacts.filter(f => 
                        mastery[selectedOp][f.q] && mastery[selectedOp][f.q].correct >= 3).length;
                    const progressPercent = (masteredInGroup / factsPerGroup[g]) * 100;
                    content += `<div>Group ${g + 1} (${groupNames[g]}): ${masteredInGroup}/${factsPerGroup[g]}</div>`;
                    content += `<div class="progress-bar"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>`;
                }
                groupProgress.innerHTML = content;
            }

            function setOperation(op, btn) {
                if (!currentUser) {
                    feedbackEl.textContent = "Select or add a user to start!";
                    return;
                }
                selectedOp = op;
                selectedGroup = null;
                document.querySelectorAll("#operation-selection button").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                groupSelection.style.display = "flex";
                document.querySelectorAll(".group-btn").forEach(b => b.classList.remove("active"));
                updateMasteryCount();
                updateGroupProgress();
                questionEl.textContent = "";
                answerEl.textContent = "";
                coverBtn.style.display = "none";
                compareBtn.style.display = "none";
                nextBtn.style.display = "none";
                userInput.style.display = "none";
                // Adjust group buttons for multiplication
                if (op === "multiplication") {
                    groupSelection.innerHTML = `
                        <button class="group-btn" data-group="0">Base Facts</button>
                        <button class="group-btn" data-group="1">Mid-Tier</button>
                        <button class="group-btn" data-group="2">Higher Facts</button>
                    `;
                } else {
                    groupSelection.innerHTML = `
                        <button class="group-btn" data-group="0">Group 1</button>
                        <button class="group-btn" data-group="1">Group 2</button>
                        <button class="group-btn" data-group="2">Group 3</button>
                        <button class="group-btn" data-group="3">Group 4</button>
                    `;
                }
                document.querySelectorAll(".group-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        selectedGroup = parseInt(btn.dataset.group);
                        document.querySelectorAll(".group-btn").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                        displayFact();
                    });
                });
            }

            addBtn.addEventListener("click", () => setOperation("addition", addBtn));
            subBtn.addEventListener("click", () => setOperation("subtraction", subBtn));
            mulBtn.addEventListener("click", () => setOperation("multiplication", mulBtn));
            divBtn.addEventListener("click", () => setOperation("division", divBtn));

            resetBtn.addEventListener("click", () => {
                if (!currentUser) {
                    feedbackEl.textContent = "Select or add a user to start!";
                    return;
                }
                if (confirm(`Are you sure you want to reset ${currentUser}'s progress?`)) {
                    mastery = { addition: {}, subtraction: {}, multiplication: {}, division: {} };
                    points = 0;
                    streak = 0;
                    saveUserData();
                    updateMasteryCount();
                    updatePointsAndLevel();
                    updateGroupProgress();
                    feedbackEl.textContent = "Progress reset! Pick an operation to start.";
                    questionEl.textContent = "";
                    answerEl.textContent = "";
                    coverBtn.style.display = "none";
                    compareBtn.style.display = "none";
                    nextBtn.style.display = "none";
                    userInput.style.display = "none";
                }
            });

            clearStorageBtn.addEventListener("click", () => {
                if (confirm("Are you sure you want to clear all local storage? This will erase all users and progress!")) {
                    localStorage.clear();
                    currentUser = null;
                    mastery = { addition: {}, subtraction: {}, multiplication: {}, division: {} };
                    points = 0;
                    streak = 0;
                    currentUserEl.textContent = "Current User: None";
                    populateUserDropdown();
                    updateMasteryCount();
                    updatePointsAndLevel();
                    updateGroupProgress();
                    feedbackEl.textContent = "Local storage cleared! Add a user to start.";
                    questionEl.textContent = "";
                    answerEl.textContent = "";
                    coverBtn.style.display = "none";
                    compareBtn.style.display = "none";
                    nextBtn.style.display = "none";
                    userInput.style.display = "none";
                    groupSelection.style.display = "none";
                    document.querySelectorAll("#operation-selection button").forEach(b => b.classList.remove("active"));
                }
            });

            summaryLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (!currentUser) {
                    feedbackEl.textContent = "Select or add a user to view summary!";
                    return;
                }
                masterySummary.style.display = "block";
                let content = `<p>Points: ${points} | Level: ${userLevelEl.textContent} | Best Streak: ${streak}</p>`;
                Object.keys(mastery).forEach(op => {
                    content += `<details><summary>${op.charAt(0).toUpperCase() + op.slice(1)}</summary>`;
                    const groupCount = op === "multiplication" ? 3 : 4;
                    const groupNames = op === "multiplication" ? 
                        ["Base Facts (1, 2, 5, 10)", "Mid-Tier (3, 4)", "Higher Facts (6, 7, 8, 9)"] : 
                        ["1-3", "4-6", "7-9", "10-12"];
                    const factsPerGroup = op === "multiplication" ? [48, 24, 48] : [36, 36, 36, 36];
                    for (let g = 0; g < groupCount; g++) {
                        const groupFacts = facts[op].filter(f => f.group === g);
                        const masteredFacts = groupFacts.filter(f => 
                            mastery[op][f.q] && mastery[op][f.q].correct >= 3).map(f => f.q);
                        const notMasteredFacts = groupFacts.filter(f => 
                            mastery[op][f.q] && mastery[op][f.q].correct < 3 && mastery[op][f.q].attempts > 0).map(f => f.q);
                        const progressPercent = (masteredFacts.length / factsPerGroup[g]) * 100;
                        content += `<h4>Group ${g + 1} (${groupNames[g]})</h4>`;
                        content += `<div class="progress-bar"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>`;
                        content += `<p>Mastered: ${masteredFacts.length}/${factsPerGroup[g]}</p>`;
                        content += `<details><summary>Mastered (${masteredFacts.length})</summary><ul>`;
                        masteredFacts.forEach(fact => content += `<li>${fact}</li>`);
                        content += `</ul></details>`;
                        content += `<details><summary>Not Mastered (${notMasteredFacts.length})</summary><ul>`;
                        notMasteredFacts.forEach(fact => content += `<li>${fact}</li>`);
                        content += `</ul></details>`;
                    }
                    content += `</details>`;
                });
                summaryContent.innerHTML = content || "No facts attempted yet!";
            });

            teacherReportLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (!teacherReport) return console.error("teacherReport not found");
                teacherReport.style.display = "block";
                let users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
                let content = "";
                console.log("Users loaded:", users);
                if (users.length === 0) {
                    content = "No users have played yet.";
                } else {
                    users.forEach(user => {
                        const userDataRaw = localStorage.getItem(`mathFactRumbleMastery_${user}`);
                        const userDataDefault = {
                            mastery: { addition: {}, subtraction: {}, multiplication: {}, division: {} },
                            points: 0,
                            streak: 0
                        };
                        const userData = userDataRaw ? JSON.parse(userDataRaw) : userDataDefault;
                        userData.mastery = {
                            addition: userData.mastery.addition || {},
                            subtraction: userData.mastery.subtraction || {},
                            multiplication: userData.mastery.multiplication || {},
                            division: userData.mastery.division || {}
                        };
                        console.log("Teacher Report User Data:", user, userData);
                        const totalMastered = Object.keys(userData.mastery).reduce((sum, op) => {
                            return sum + Object.values(userData.mastery[op]).filter(m => m.correct >= 3).length;
                        }, 0);
                        content += `<h3>${user} (Total Mastered: ${totalMastered}, Points: ${userData.points}, Best Streak: ${userData.streak})</h3>`;
                        Object.keys(userData.mastery).forEach(op => {
                            const opMastered = Object.values(userData.mastery[op]).filter(m => m.correct >= 3).length;
                            const totalFacts = op === "multiplication" ? 120 : 144; // 48 + 24 + 48 = 120 for mul
                            content += `<details><summary>${op.charAt(0).toUpperCase() + op.slice(1)} (Mastered: ${opMastered}/${totalFacts})</summary>`;
                            const allAttempts = Object.entries(userData.mastery[op])
                                .filter(([_, data]) => data.attempts > 0)
                                .map(([q, data]) => ({ q, ...data }));
                            console.log(`Attempts for ${op} by ${user}:`, allAttempts);
                            if (allAttempts.length > 0) {
                                content += `<ul>`;
                                allAttempts.forEach(f => {
                                    const incorrect = f.attempts - f.correct;
                                    content += `<li>${f.q} - Attempts: ${f.attempts}, Correct: ${f.correct}, Incorrect: ${incorrect}</li>`;
                                });
                                content += `</ul>`;
                            } else {
                                content += `<p>No attempts recorded for this operation.</p>`;
                            }
                            content += `</details>`;
                        });
                    });
                }
                console.log("Setting reportContent to:", content);
                if (!reportContent) console.error("reportContent not found");
                reportContent.innerHTML = content || "No user progress recorded yet!";
            });

            downloadBtn.addEventListener("click", () => {
                if (!currentUser) {
                    feedbackEl.textContent = "Select or add a user to download results!";
                    return;
                }
                let csvContent = "Operation,Group,Fact,Status,Points,Streak\n";
                Object.keys(mastery).forEach(op => {
                    const groupCount = op === "multiplication" ? 3 : 4;
                    const groupNames = op === "multiplication" ? 
                        ["Base Facts (1, 2, 5, 10)", "Mid-Tier (3, 4)", "Higher Facts (6, 7, 8, 9)"] : 
                        ["1-3", "4-6", "7-9", "10-12"];
                    const factsPerGroup = op === "multiplication" ? [48, 24, 48] : [36, 36, 36, 36];
                    for (let g = 0; g < groupCount; g++) {
                        const groupFacts = facts[op].filter(f => f.group === g);
                        const masteredFacts = groupFacts.filter(f => 
                            mastery[op][f.q] && mastery[op][f.q].correct >= 3).map(f => f.q);
                        const notMasteredFacts = groupFacts.filter(f => 
                            mastery[op][f.q] && mastery[op][f.q].correct < 3 && mastery[op][f.q].attempts > 0).map(f => f.q);
                        masteredFacts.forEach(fact => {
                            csvContent += `${op},${groupNames[g]},"${fact}",Mastered,${points},${streak}\n`;
                        });
                        notMasteredFacts.forEach(fact => {
                            csvContent += `${op},${groupNames[g]},"${fact}",Not Mastered,${points},${streak}\n`;
                        });
                    }
                });
                const blob = new Blob([csvContent], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `math_fact_rumble_results_${currentUser}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            downloadReportBtn.addEventListener("click", () => {
                const now = new Date().toISOString();
                let csvContent = `Teacher Report - Generated: ${now}\n`;
                csvContent += "User,Operation,Group,Fact,Attempts,Correct,Incorrect,Mastered,Points,Streak,Last Attempt\n";
                let users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
                console.log("Download Users:", users);
                if (users.length === 0) {
                    csvContent += "No users have played yet.\n";
                } else {
                    users.forEach(user => {
                        const userDataRaw = localStorage.getItem(`mathFactRumbleMastery_${user}`);
                        const userDataDefault = {
                            mastery: { addition: {}, subtraction: {}, multiplication: {}, division: {} },
                            points: 0,
                            streak: 0
                        };
                        const userData = userDataRaw ? JSON.parse(userDataRaw) : userDataDefault;
                        userData.mastery = {
                            addition: userData.mastery.addition || {},
                            subtraction: userData.mastery.subtraction || {},
                            multiplication: userData.mastery.multiplication || {},
                            division: userData.mastery.division || {}
                        };
                        console.log("Download Report User Data:", user, userData);
                        Object.keys(userData.mastery).forEach(op => {
                            const allAttempts = Object.entries(userData.mastery[op])
                                .filter(([_, data]) => data.attempts > 0)
                                .map(([q, data]) => {
                                    const fact = facts[op].find(f => f.q === q);
                                    const groupNames = op === "multiplication" ? 
                                        ["Base Facts (1, 2, 5, 10)", "Mid-Tier (3, 4)", "Higher Facts (6, 7, 8, 9)"] : 
                                        ["1-3", "4-6", "7-9", "10-12"];
                                    const group = fact ? groupNames[fact.group] : "Unknown";
                                    return { q, group, ...data };
                                });
                            allAttempts.sort((a, b) => a.q.localeCompare(b.q));
                            allAttempts.forEach(f => {
                                const incorrect = f.attempts - f.correct;
                                const mastered = f.correct >= 3 ? "Yes" : "No";
                                const lastAttempt = f.lastAttempt || "N/A";
                                csvContent += `"${user}",${op},"${f.group}","${f.q}",${f.attempts},${f.correct},${incorrect},${mastered},${userData.points},${userData.streak},${lastAttempt}\n`;
                            });
                        });
                    });
                }
                console.log("Generated CSV:", csvContent);
                const blob = new Blob([csvContent], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `math_fact_rumble_teacher_report_${now.replace(/:/g, "-")}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            closeSummaryBtn.addEventListener("click", () => {
                masterySummary.style.display = "none";
            });

            closeReportBtn.addEventListener("click", () => {
                teacherReport.style.display = "none";
            });

            feedbackEl.textContent = "Select or add a user to start!";
            opMasteryEl.textContent = "0/144";
            populateUserDropdown();
            const lastUser = localStorage.getItem("mathFactRumbleCurrentUser");
            if (lastUser) loadUserData(lastUser);
        });
    </script>
</body>
</html>
