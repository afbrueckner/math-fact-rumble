<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Fact Rumble</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        #container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #45a049; }
        #feedback { font-weight: bold; margin: 10px 0; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .progress-bar {
            width: 100%;
            background: #ddd;
            height: 20px;
            border-radius: 10px;
            margin: 5px 0;
        }
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 10px;
        }
        details { margin: 10px 0; }
        summary { cursor: pointer; }
        ul { padding-left: 20px; }
        #new-user-input { margin-top: 10px; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Math Fact Rumble</h1>
        <div id="current-user">Current User: None</div>
        <div>
            <select id="user-select"><option value="" selected>Select a user</option></select>
            <button id="load-user-btn">Load User</button>
            <button id="add-user-btn">Add User</button>
            <button id="clear-data-btn">Clear Local Data</button>
        </div>
        <div id="new-user-input" style="display: none;">
            <input type="text" id="user-name" placeholder="Enter user name">
            <button id="save-name-btn">Save</button>
        </div>
        <div>Total Mastered: <span id="mastery-count">0</span></div>
        <div>Operation Mastery: <span id="op-mastery">0/144</span></div>
        <div>Points: <span id="user-points">0</span> | Level: <span id="user-level">Novice</span> | Streak: <span id="streak-count">0</span></div>
        <div id="operation-selection">
            <button id="addBtn">Addition</button>
            <button id="subBtn">Subtraction</button>
            <button id="mulBtn">Multiplication</button>
            <button id="divBtn">Division</button>
        </div>
        <div id="group-selection" style="display: none;">
            <button class="group-btn" data-group="0">Group 1</button>
            <button class="group-btn" data-group="1">Group 2</button>
            <button class="group-btn" data-group="2">Group 3</button>
            <button class="group-btn" data-group="3">Group 4</button>
        </div>
        <div id="group-progress"></div>
        <div id="question"></div>
        <span id="answer"></span>
        <input type="number" id="user-input" style="display: none;">
        <div>
            <button id="coverBtn" style="display: none;">Cover</button>
            <button id="compareBtn" style="display: none;">Compare</button>
            <button id="nextBtn" style="display: none;">Next</button>
        </div>
        <div id="feedback">Select or add a user to start!</div>
        <div>
            <button id="reset-btn">Reset Progress</button>
            <a href="#" id="summary-link">Mastery Summary</a>
            <a href="#" id="teacher-report-link">Teacher Report</a>
        </div>
        <div id="mastery-summary" class="modal">
            <div class="modal-content">
                <h2>Mastery Summary</h2>
                <div id="summary-content"></div>
                <button id="download-btn">Download Results</button>
                <button id="close-summary">Close</button>
            </div>
        </div>
        <div id="teacher-report" class="modal">
            <div class="modal-content">
                <h2>Teacher Report</h2>
                <div id="report-content"></div>
                <button id="download-report-btn">Download Report</button>
                <button id="close-report">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const facts = {
                addition: Array.from({ length: 144 }, (_, i) => {
                    const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                    return { q: `${a} + ${b}`, a: a + b, group: Math.floor((a - 1) / 3) };
                }),
                subtraction: Array.from({ length: 144 }, (_, i) => {
                    const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                    return { q: `${a + b} - ${b}`, a: a, group: Math.floor((a - 1) / 3) };
                }),
                multiplication: Array.from({ length: 144 }, (_, i) => {
                    const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                    return { q: `${a} × ${b}`, a: a * b, group: Math.floor((a - 1) / 3) };
                }),
                division: Array.from({ length: 144 }, (_, i) => {
                    const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                    return { q: `${a * b} ÷ ${b}`, a: a, group: Math.floor((a - 1) / 3) };
                })
            };

            const questionEl = document.getElementById("question");
            const answerEl = document.getElementById("answer");
            const userInput = document.getElementById("user-input");
            const feedbackEl = document.getElementById("feedback");
            const coverBtn = document.getElementById("coverBtn");
            const compareBtn = document.getElementById("compareBtn");
            const nextBtn = document.getElementById("nextBtn");
            const opMasteryEl = document.getElementById("op-mastery");
            const masteryCountEl = document.getElementById("mastery-count");
            const addBtn = document.getElementById("addBtn");
            const subBtn = document.getElementById("subBtn");
            const mulBtn = document.getElementById("mulBtn");
            const divBtn = document.getElementById("divBtn");
            const resetBtn = document.getElementById("reset-btn");
            const summaryLink = document.getElementById("summary-link");
            const teacherReportLink = document.getElementById("teacher-report-link");
            const masterySummary = document.getElementById("mastery-summary");
            const summaryContent = document.getElementById("summary-content");
            const closeSummaryBtn = document.getElementById("close-summary");
            const downloadBtn = document.getElementById("download-btn");
            const teacherReport = document.getElementById("teacher-report");
            const reportContent = document.getElementById("report-content");
            const closeReportBtn = document.getElementById("close-report");
            const downloadReportBtn = document.getElementById("download-report-btn");
            const userSelect = document.getElementById("user-select");
            const loadUserBtn = document.getElementById("load-user-btn");
            const addUserBtn = document.getElementById("add-user-btn");
            const newUserInput = document.getElementById("new-user-input");
            const userNameInput = document.getElementById("user-name");
            const saveNameBtn = document.getElementById("save-name-btn");
            const currentUserEl = document.getElementById("current-user");
            const groupSelection = document.getElementById("group-selection");
            const groupProgress = document.getElementById("group-progress");
            const userPointsEl = document.getElementById("user-points");
            const userLevelEl = document.getElementById("user-level");
            const streakCountEl = document.getElementById("streak-count");

            let currentFact = null, selectedOp = null, selectedGroup = null, currentUser = null;
            let mastery = { addition: {}, subtraction: {}, multiplication: {}, division: {} };
            let points = 0, streak = 0;

            const levels = [
                { name: "Novice", threshold: 0 },
                { name: "Mathlete", threshold: 100 },
                { name: "Champion", threshold: 300 },
                { name: "Legend", threshold: 500 }
            ];

            function populateUserDropdown() {
                const users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
                userSelect.innerHTML = '<option value="" selected>Select a user</option>';
                users.forEach(user => {
                    const option = document.createElement("option");
                    option.value = user;
                    option.textContent = user;
                    userSelect.appendChild(option);
                });
            }

            function loadUserData(username) {
                if (!username) return;
                currentUser = username;
                localStorage.setItem("mathFactRumbleCurrentUser", currentUser);
                currentUserEl.textContent = `Current User: ${currentUser}`;
                const userDataRaw = localStorage.getItem(`mathFactRumbleMastery_${currentUser}`);
                let userData;
                try {
                    userData = JSON.parse(userDataRaw) || {
                        mastery: { addition: {}, subtraction: {}, multiplication: {}, division: {} },
                        points: 0,
                        streak: 0
                    };
                } catch (e) {
                    console.error("Failed to parse user data:", e);
                    userData = { mastery: { addition: {}, subtraction: {}, multiplication: {}, division: {} }, points: 0, streak: 0 };
                }
                mastery = {
                    addition: userData.mastery.addition || {},
                    subtraction: userData.mastery.subtraction || {},
                    multiplication: userData.mastery.multiplication || {},
                    division: userData.mastery.division || {}
                };
                points = userData.points || 0;
                streak = userData.streak || 0;
                updateMasteryCount();
                updatePointsAndLevel();
                feedbackEl.textContent = "Pick an operation to start!";
            }

            function saveUserData() {
                if (currentUser) {
                    const dataToSave = { mastery, points, streak };
                    localStorage.setItem(`mathFactRumbleMastery_${currentUser}`, JSON.stringify(dataToSave));
                    console.log("Saved data for", currentUser, dataToSave);
                }
            }

            loadUserBtn.addEventListener("click", () => {
                const selectedUser = userSelect.value;
                if (selectedUser) loadUserData(selectedUser);
                else feedbackEl.textContent = "Please select a user!";
            });

            addUserBtn.addEventListener("click", () => {
                newUserInput.style.display = "block";
                userNameInput.focus();
            });

            saveNameBtn.addEventListener("click", () => {
                const name = userNameInput.value.trim();
                if (name) {
                    let users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
                    if (!users.includes(name)) {
                        users.push(name);
                        localStorage.setItem("mathFactRumbleUsers", JSON.stringify(users));
                    }
                    loadUserData(name);
                    populateUserDropdown();
                    newUserInput.style.display = "none";
                    userNameInput.value = "";
                } else {
                    feedbackEl.textContent = "Please enter a name!";
                }
            });

            function getRandomFact() {
                if (!selectedOp || selectedGroup === null) {
                    feedbackEl.textContent = selectedOp ? "Pick a group to start!" : "Pick an operation to start!";
                    return null;
                }
                const groupFacts = facts[selectedOp].filter(f => f.group === selectedGroup);
                return groupFacts[Math.floor(Math.random() * groupFacts.length)];
            }

            function displayFact() {
                if (!currentUser) {
                    feedbackEl.textContent = "Select or add a user to start!";
                    return;
                }
                currentFact = getRandomFact();
                if (!currentFact) return;
                questionEl.textContent = currentFact.q;
                answerEl.textContent = currentFact.a;
                answerEl.style.display = "inline";
                userInput.style.display = "none";
                userInput.value = "";
                feedbackEl.textContent = "";
                coverBtn.style.display = "inline";
                compareBtn.style.display = "none";
                nextBtn.style.display = "none";
            }

            coverBtn.addEventListener("click", () => {
                if (!currentFact) return;
                answerEl.style.display = "none";
                userInput.style.display = "inline";
                coverBtn.style.display = "none";
                compareBtn.style.display = "inline";
                userInput.focus();
            });

            compareBtn.addEventListener("click", () => {
                console.log("Compare clicked", { currentFact, selectedOp });
                if (!currentFact || !selectedOp) {
                    feedbackEl.textContent = "Error: No fact or operation selected!";
                    return;
                }
                const userAnswer = parseInt(userInput.value);
                if (isNaN(userAnswer)) {
                    feedbackEl.textContent = "Please enter a number!";
                    return;
                }
                mastery[selectedOp][currentFact.q] = mastery[selectedOp][currentFact.q] || { attempts: 0, correct: 0, lastAttempt: null };
                mastery[selectedOp][currentFact.q].attempts++;
                mastery[selectedOp][currentFact.q].lastAttempt = new Date().toISOString();
                if (userAnswer === currentFact.a) {
                    mastery[selectedOp][currentFact.q].correct++;
                    points += 10;
                    streak++;
                    if (streak % 3 === 0) {
                        points += 20;
                        feedbackEl.textContent = `Streak ${streak}! +20 Bonus!`;
                    } else {
                        feedbackEl.textContent = "You pinned that fact!";
                    }
                    feedbackEl.style.color = "green";
                } else {
                    feedbackEl.textContent = `Ouch! It’s ${currentFact.a}. Try again!`;
                    feedbackEl.style.color = "red";
                    streak = 0;
                }
                saveUserData();
                updateMasteryCount();
                updatePointsAndLevel();
                updateGroupProgress();
                compareBtn.style.display = "none";
                nextBtn.style.display = "inline";
                nextBtn.focus();
            });

            userInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter" && compareBtn.style.display === "inline") compareBtn.click();
            });

            nextBtn.addEventListener("click", displayFact);
            nextBtn.addEventListener("keypress", (e) => {
                if (e.key === "Enter") displayFact();
            });

            function updateMasteryCount() {
                if (!mastery || typeof mastery !== "object") {
                    mastery = { addition: {}, subtraction: {}, multiplication: {}, division: {} };
                }
                const totalMastered = Object.keys(mastery).reduce((sum, op) => {
                    return sum + Object.values(mastery[op] || {}).filter(m => m.correct >= 3).length;
                }, 0);
                masteryCountEl.textContent = totalMastered;
                const opMastered = selectedOp ? Object.values(mastery[selectedOp] || {}).filter(m => m.correct >= 3).length : 0;
                opMasteryEl.textContent = `${opMastered}/144`;
            }

            function updatePointsAndLevel() {
                userPointsEl.textContent = points;
                streakCountEl.textContent = streak;
                const currentLevel = levels.reduce((prev, curr) => 
                    points >= curr.threshold ? curr : prev, levels[0]);
                userLevelEl.textContent = currentLevel.name;
            }

            function updateGroupProgress() {
                if (!selectedOp) return;
                let content = "";
                for (let g = 0; g < 4; g++) {
                    const groupFacts = facts[selectedOp].filter(f => f.group === g);
                    const masteredInGroup = groupFacts.filter(f => 
                        mastery[selectedOp][f.q] && mastery[selectedOp][f.q].correct >= 3).length;
                    const progressPercent = (masteredInGroup / 36) * 100;
                    content += `<div>Group ${g + 1} (${g * 3 + 1}-${g * 3 + 3}): ${masteredInGroup}/36</div>`;
                    content += `<div class="progress-bar"><div class="progress-fill" style="width: ${
