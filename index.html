<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Math Fact Rumble</title>
    <style>
        #game-container {
            text-align: center;
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #333;
            color: #fff;
            border-radius: 10px;
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            color: #ffd700;
            font-size: 28px;
        }
        #user-section {
            margin: 10px 0;
        }
        #user-select, #user-name {
            padding: 5px;
            font-size: 14px;
            margin-right: 5px;
        }
        #load-user-btn, #add-user-btn, #save-name-btn {
            padding: 5px 10px;
            font-size: 14px;
            background: #1e90ff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #load-user-btn:hover, #add-user-btn:hover, #save-name-btn:hover {
            background: #4682b4;
        }
        #current-user {
            margin-left: 10px;
            font-size: 14px;
        }
        #operation-selection, #group-selection {
            margin: 10px 0;
        }
        #operation-selection button, #group-selection button {
            padding: 8px 15px;
            margin: 5px;
            font-size: 14px;
            background: #1e90ff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #operation-selection button:hover, #group-selection button:hover {
            background: #4682b4;
        }
        #operation-selection button.active, #group-selection button.active {
            background: #ff4500;
        }
        #group-progress {
            margin-top: 10px;
        }
        #fact-display {
            font-size: 24px;
            margin: 20px 0;
        }
        #user-input {
            padding: 10px;
            font-size: 28px;
            width: 120px;
            margin: 10px 0;
        }
        button:not(#operation-selection button, #group-btn, #load-user-btn, #add-user-btn, #save-name-btn) {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            background: #ff4500;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        button:hover:not(#operation-selection button, #group-btn, #load-user-btn, #add-user-btn, #save-name-btn) {
            background: #ff6347;
        }
        #feedback {
            margin: 10px 0;
            font-weight: bold;
        }
        #points, #progress {
            font-size: 18px;
            margin: 10px 0;
        }
        #reset-btn {
            background: #dc143c;
        }
        #reset-btn:hover {
            background: #ff4040;
        }
        #summary-link, #teacher-report-link {
            color: #ffd700;
            text-decoration: underline;
            cursor: pointer;
            margin: 0 10px;
        }
        #mastery-summary, #teacher-report {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: #444;
            padding: 20px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
            width: 80%;
            max-width: 500px;
        }
        #mastery-summary h2, #teacher-report h2 {
            margin: 0 0 10px;
            color: #ffd700;
        }
        #close-summary, #download-btn, #close-report, #download-report-btn {
            background: #ff4500;
            margin: 5px;
        }
        #summary-content, #report-content {
            text-align: left;
            font-size: 14px;
        }
        details {
            margin: 10px 0;
        }
        summary {
            cursor: pointer;
            color: #ffd700;
        }
        ul {
            margin: 5px 0 0 20px;
        }
        .progress-bar {
            width: 100%;
            background: #666;
            height: 20px;
            border-radius: 5px;
            margin: 5px 0;
        }
        .progress-fill {
            height: 100%;
            background: #ffd700;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Math Fact Rumble</h1>
        <div id="user-section">
            <select id="user-select">
                <option value="" selected>Select a user</option>
            </select>
            <button id="load-user-btn">Load User</button>
            <button id="add-user-btn">Add New User</button>
            <div id="new-user-input" style="display: none;">
                <input type="text" id="user-name" placeholder="Enter new user name">
                <button id="save-name-btn">Save</button>
            </div>
            <span id="current-user">Current User: None</span>
        </div>
        <div id="points">Mastery: <span id="op-mastery">0/144</span></div>
        <div id="operation-selection">
            <button id="addBtn">Addition</button>
            <button id="subBtn">Subtraction</button>
            <button id="mulBtn">Multiplication</button>
            <button id="divBtn">Division</button>
        </div>
        <div id="group-selection" style="display: none;">
            <h3>Select a Group</h3>
            <button class="group-btn" data-group="0">Group 1 (1-3)</button>
            <button class="group-btn" data-group="1">Group 2 (4-6)</button>
            <button class="group-btn" data-group="2">Group 3 (7-9)</button>
            <button class="group-btn" data-group="3">Group 4 (10-12)</button>
            <div id="group-progress"></div>
        </div>
        <div id="fact-display">
            <span id="question"></span> = <span id="answer"></span>
        </div>
        <input type="text" id="user-input" placeholder="Type your answer" style="display: none;">
        <div id="feedback"></div>
        <button id="coverBtn" style="display: none;">Cover</button>
        <button id="compareBtn" style="display: none;">Compare</button>
        <button id="nextBtn" style="display: none;">Next Fact</button>
        <div id="progress">Total Mastered: <span id="mastery-count">0</span></div>
        <button id="reset-btn">Reset Progress</button>
        <a href="#" id="summary-link">View Mastery Summary</a>
        <a href="#" id="teacher-report-link">Teacher Report</a>
        <div id="mastery-summary" style="display: none;">
            <h2>Mastery Summary</h2>
            <button id="download-btn">Download Results</button>
            <button id="close-summary">Close</button>
            <div id="summary-content"></div>
        </div>
        <div id="teacher-report" style="display: none;">
            <h2>Teacher Report</h2>
            <button id="download-report-btn">Download Report</button>
            <button id="close-report">Close</button>
            <div id="report-content"></div>
        </div>
    </div>

    <script>
        // All facts grouped by first operand (1-3, 4-6, 7-9, 10-12)
        const facts = {
            addition: Array.from({ length: 144 }, (_, i) => {
                const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                return { q: `${a} + ${b}`, a: a + b, group: Math.floor((a - 1) / 3) };
            }),
            subtraction: Array.from({ length: 144 }, (_, i) => {
                const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                return { q: `${a + b} - ${b}`, a: a, group: Math.floor((a - 1) / 3) };
            }),
            multiplication: Array.from({ length: 144 }, (_, i) => {
                const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                return { q: `${a} ร ${b}`, a: a * b, group: Math.floor((a - 1) / 3) };
            }),
            division: Array.from({ length: 144 }, (_, i) => {
                const a = Math.floor(i / 12) + 1, b = (i % 12) + 1;
                return { q: `${a * b} รท ${b}`, a: a, group: Math.floor((a - 1) / 3) };
            })
        };

        // DOM elements
        const questionEl = document.getElementById("question");
        const answerEl = document.getElementById("answer");
        const userInput = document.getElementById("user-input");
        const feedbackEl = document.getElementById("feedback");
        const coverBtn = document.getElementById("coverBtn");
        const compareBtn = document.getElementById("compareBtn");
        const nextBtn = document.getElementById("nextBtn");
        const opMasteryEl = document.getElementById("op-mastery");
        const masteryCountEl = document.getElementById("mastery-count");
        const addBtn = document.getElementById("addBtn");
        const subBtn = document.getElementById("subBtn");
        const mulBtn = document.getElementById("mulBtn");
        const divBtn = document.getElementById("divBtn");
        const resetBtn = document.getElementById("reset-btn");
        const summaryLink = document.getElementById("summary-link");
        const teacherReportLink = document.getElementById("teacher-report-link");
        const masterySummary = document.getElementById("mastery-summary");
        const summaryContent = document.getElementById("summary-content");
        const closeSummaryBtn = document.getElementById("close-summary");
        const downloadBtn = document.getElementById("download-btn");
        const teacherReport = document.getElementById("teacher-report");
        const reportContent = document.getElementById("report-content");
        const closeReportBtn = document.getElementById("close-report");
        const downloadReportBtn = document.getElementById("download-report-btn");
        const userSelect = document.getElementById("user-select");
        const loadUserBtn = document.getElementById("load-user-btn");
        const addUserBtn = document.getElementById("add-user-btn");
        const newUserInput = document.getElementById("new-user-input");
        const userNameInput = document.getElementById("user-name");
        const saveNameBtn = document.getElementById("save-name-btn");
        const currentUserEl = document.getElementById("current-user");
        const groupSelection = document.getElementById("group-selection");
        const groupProgress = document.getElementById("group-progress");

        let currentFact, selectedOp = null, selectedGroup = null, currentUser = null;
        let mastery = { addition: {}, subtraction: {}, multiplication: {}, division: {} };

        // Populate user dropdown
        function populateUserDropdown() {
            const users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
            userSelect.innerHTML = '<option value="" selected>Select a user</option>';
            users.forEach(user => {
                const option = document.createElement("option");
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });
        }

        // Load user data
        function loadUserData(username) {
            if (username) {
                currentUser = username;
                localStorage.setItem("mathFactRumbleCurrentUser", currentUser);
                currentUserEl.textContent = `Current User: ${currentUser}`;
                mastery = JSON.parse(localStorage.getItem(`mathFactRumbleMastery_${currentUser}`)) || {
                    addition: {},
                    subtraction: {},
                    multiplication: {},
                    division: {}
                };
                updateMasteryCount();
                feedbackEl.textContent = "Pick an operation to start!";
            }
        }

        // Load selected user
        loadUserBtn.addEventListener("click", () => {
            const selectedUser = userSelect.value;
            if (selectedUser) {
                loadUserData(selectedUser);
            } else {
                feedbackEl.textContent = "Please select a user!";
            }
        });

        // Show new user input
        addUserBtn.addEventListener("click", () => {
            newUserInput.style.display = "block";
            userNameInput.focus();
        });

        // Save new user name
        saveNameBtn.addEventListener("click", () => {
            const name = userNameInput.value.trim();
            if (name) {
                let users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
                if (!users.includes(name)) {
                    users.push(name);
                    localStorage.setItem("mathFactRumbleUsers", JSON.stringify(users));
                }
                loadUserData(name);
                populateUserDropdown();
                newUserInput.style.display = "none";
                userNameInput.value = "";
            } else {
                feedbackEl.textContent = "Please enter a name!";
            }
        });

        // Get a random fact based on selected operation and group
        function getRandomFact() {
            if (!selectedOp || selectedGroup === null) {
                feedbackEl.textContent = selectedOp ? "Pick a group to start!" : "Pick an operation to start!";
                return null;
            }
            const groupFacts = facts[selectedOp].filter(f => f.group === selectedGroup);
            return groupFacts[Math.floor(Math.random() * groupFacts.length)];
        }

        // Display a new fact
        function displayFact() {
            if (!currentUser) {
                feedbackEl.textContent = "Select or add a user to start!";
                return;
            }
            currentFact = getRandomFact();
            if (!currentFact) return;
            questionEl.textContent = currentFact.q;
            answerEl.textContent = currentFact.a;
            answerEl.style.display = "inline";
            userInput.style.display = "none";
            userInput.value = "";
            feedbackEl.textContent = "";
            coverBtn.style.display = "inline";
            compareBtn.style.display = "none";
            nextBtn.style.display = "none";
        }

        // Cover the answer
        coverBtn.addEventListener("click", () => {
            answerEl.style.display = "none";
            userInput.style.display = "inline";
            coverBtn.style.display = "none";
            compareBtn.style.display = "inline";
            userInput.focus();
        });

        // Compare and track mastery
        compareBtn.addEventListener("click", () => {
            const userAnswer = parseInt(userInput.value);
            mastery[selectedOp][currentFact.q] = mastery[selectedOp][currentFact.q] || { attempts: 0, correct: 0 };
            mastery[selectedOp][currentFact.q].attempts++;
            if (userAnswer === currentFact.a) {
                feedbackEl.textContent = "You pinned that fact!";
                feedbackEl.style.color = "green";
                mastery[selectedOp][currentFact.q].correct++;
            } else {
                feedbackEl.textContent = `Ouch! Itโs ${currentFact.a}. Try again!`;
                feedbackEl.style.color = "red";
            }
            localStorage.setItem(`mathFactRumbleMastery_${currentUser}`, JSON.stringify(mastery));
            updateMasteryCount();
            updateGroupProgress();
            compareBtn.style.display = "none";
            nextBtn.style.display = "inline";
            nextBtn.focus();
        });

        // Enter key to trigger Compare
        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && compareBtn.style.display === "inline") {
                compareBtn.click();
            }
        });

        // Next fact
        nextBtn.addEventListener("click", () => {
            displayFact();
        });

        // Enter key to trigger Next Fact
        nextBtn.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                nextBtn.click();
            }
        });

        // Update mastery counts
        function updateMasteryCount() {
            const totalMastered = Object.keys(mastery).reduce((sum, op) => {
                return sum + Object.values(mastery[op]).filter(m => m.correct >= 3).length;
            }, 0);
            masteryCountEl.textContent = totalMastered;

            const opMastered = selectedOp
                ? Object.values(mastery[selectedOp]).filter(m => m.correct >= 3).length
                : 0;
            opMasteryEl.textContent = `${opMastered}/144`;
        }

        // Update group progress bars
        function updateGroupProgress() {
            if (!selectedOp) return;
            let content = "";
            for (let g = 0; g < 4; g++) {
                const groupFacts = facts[selectedOp].filter(f => f.group === g);
                const masteredInGroup = groupFacts.filter(f => 
                    mastery[selectedOp][f.q] && mastery[selectedOp][f.q].correct >= 3).length;
                const progressPercent = (masteredInGroup / 36) * 100;
                content += `<div>Group ${g + 1} (${g * 3 + 1}-${g * 3 + 3}): ${masteredInGroup}/36</div>`;
                content += `<div class="progress-bar"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>`;
            }
            groupProgress.innerHTML = content;
        }

        // Operation selection
        function setOperation(op, btn) {
            if (!currentUser) {
                feedbackEl.textContent = "Select or add a user to start!";
                return;
            }
            selectedOp = op;
            selectedGroup = null;
            document.querySelectorAll("#operation-selection button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            groupSelection.style.display = "block";
            document.querySelectorAll(".group-btn").forEach(b => b.classList.remove("active"));
            updateMasteryCount();
            updateGroupProgress();
            questionEl.textContent = "";
            answerEl.textContent = "";
            coverBtn.style.display = "none";
            compareBtn.style.display = "none";
            nextBtn.style.display = "none";
            userInput.style.display = "none";
        }

        addBtn.addEventListener("click", () => setOperation("addition", addBtn));
        subBtn.addEventListener("click", () => setOperation("subtraction", subBtn));
        mulBtn.addEventListener("click", () => setOperation("multiplication", mulBtn));
        divBtn.addEventListener("click", () => setOperation("division", divBtn));

        // Group selection
        document.querySelectorAll(".group-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                selectedGroup = parseInt(btn.dataset.group);
                document.querySelectorAll(".group-btn").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                displayFact();
            });
        });

        // Reset progress
        resetBtn.addEventListener("click", () => {
            if (!currentUser) {
                feedbackEl.textContent = "Select or add a user to start!";
                return;
            }
            if (confirm(`Are you sure you want to reset ${currentUser}'s progress?`)) {
                mastery = { addition: {}, subtraction: {}, multiplication: {}, division: {} };
                localStorage.setItem(`mathFactRumbleMastery_${currentUser}`, JSON.stringify(mastery));
                updateMasteryCount();
                updateGroupProgress();
                feedbackEl.textContent = "Progress reset! Pick an operation to start.";
                questionEl.textContent = "";
                answerEl.textContent = "";
                coverBtn.style.display = "none";
                compareBtn.style.display = "none";
                nextBtn.style.display = "none";
                userInput.style.display = "none";
            }
        });

        // Mastery summary with grouped progress
        summaryLink.addEventListener("click", (e) => {
            e.preventDefault();
            if (!currentUser) {
                feedbackEl.textContent = "Select or add a user to view summary!";
                return;
            }
            masterySummary.style.display = "block";
            let content = "";
            Object.keys(mastery).forEach(op => {
                content += `<details><summary>${op.charAt(0).toUpperCase() + op.slice(1)}</summary>`;
                for (let g = 0; g < 4; g++) {
                    const groupFacts = facts[op].filter(f => f.group === g);
                    const masteredFacts = groupFacts.filter(f => 
                        mastery[op][f.q] && mastery[op][f.q].correct >= 3).map(f => f.q);
                    const notMasteredFacts = groupFacts.filter(f => 
                        mastery[op][f.q] && mastery[op][f.q].correct < 3 && mastery[op][f.q].attempts > 0).map(f => f.q);
                    const progressPercent = (masteredFacts.length / 36) * 100;

                    content += `<h4>Group ${g + 1} (${g * 3 + 1}-${g * 3 + 3})</h4>`;
                    content += `<div class="progress-bar"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>`;
                    content += `<p>Mastered: ${masteredFacts.length}/36</p>`;
                    content += `<details><summary>Mastered (${masteredFacts.length})</summary><ul>`;
                    masteredFacts.forEach(fact => content += `<li>${fact}</li>`);
                    content += `</ul></details>`;
                    content += `<details><summary>Not Mastered (${notMasteredFacts.length})</summary><ul>`;
                    notMasteredFacts.forEach(fact => content += `<li>${fact}</li>`);
                    content += `</ul></details>`;
                }
                content += `</details>`;
            });
            summaryContent.innerHTML = content || "No facts attempted yet!";
        });

        // Teacher report with grouped attempts
        teacherReportLink.addEventListener("click", (e) => {
            e.preventDefault();
            teacherReport.style.display = "block";
            let users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];
            let content = "";

            if (users.length === 0) {
                content = "No users have played yet.";
            } else {
                users.forEach(user => {
                    const userMastery = JSON.parse(localStorage.getItem(`mathFactRumbleMastery_${user}`)) || {
                        addition: {},
                        subtraction: {},
                        multiplication: {},
                        division: {}
                    };
                    const totalMastered = Object.keys(userMastery).reduce((sum, op) => {
                        return sum + Object.values(userMastery[op]).filter(m => m.correct >= 3).length;
                    }, 0);
                    content += `<h3>${user} (Total Mastered: ${totalMastered})</h3>`;

                    Object.keys(userMastery).forEach(op => {
                        const opMastered = Object.values(userMastery[op]).filter(m => m.correct >= 3).length;
                        content += `<details><summary>${op.charAt(0).toUpperCase() + op.slice(1)} (Mastered: ${opMastered}/144)</summary>`;
                        for (let g = 0; g < 4; g++) {
                            const groupFacts = facts[op].filter(f => f.group === g);
                            const allAttempts = groupFacts.filter(f => userMastery[op][f.q] && userMastery[op][f.q].attempts > 0);
                            const masteredCount = groupFacts.filter(f => 
                                userMastery[op][f.q] && userMastery[op][f.q].correct >= 3).length;
                            const progressPercent = (masteredCount / 36) * 100;

                            if (allAttempts.length > 0) {
                                content += `<h4>Group ${g + 1} (${g * 3 + 1}-${g * 3 + 3})</h4>`;
                                content += `<div class="progress-bar"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>`;
                                content += `<p>Mastered: ${masteredCount}/36</p>`;
                                content += `<ul>`;
                                allAttempts.forEach(f => {
                                    const data = userMastery[op][f.q];
                                    const incorrect = data.attempts - data.correct;
                                    content += `<li>${f.q} - Attempts: ${data.attempts}, Correct: ${data.correct}, Incorrect: ${incorrect}</li>`;
                                });
                                content += `</ul>`;
                            }
                        }
                        content += `</details>`;
                    });
                });
            }
            reportContent.innerHTML = content || "No user progress recorded yet!";
        });

        // Download user summary as CSV
        downloadBtn.addEventListener("click", () => {
            if (!currentUser) {
                feedbackEl.textContent = "Select or add a user to download results!";
                return;
            }
            let csvContent = "Operation,Group,Fact,Status\n";
            Object.keys(mastery).forEach(op => {
                for (let g = 0; g < 4; g++) {
                    const groupFacts = facts[op].filter(f => f.group === g);
                    const masteredFacts = groupFacts.filter(f => 
                        mastery[op][f.q] && mastery[op][f.q].correct >= 3).map(f => f.q);
                    const notMasteredFacts = groupFacts.filter(f => 
                        mastery[op][f.q] && mastery[op][f.q].correct < 3 && mastery[op][f.q].attempts > 0).map(f => f.q);

                    masteredFacts.forEach(fact => {
                        csvContent += `${op},${g + 1} (${g * 3 + 1}-${g * 3 + 3}),"${fact}",Mastered\n`;
                    });
                    notMasteredFacts.forEach(fact => {
                        csvContent += `${op},${g + 1} (${g * 3 + 1}-${g * 3 + 3}),"${fact}",Not Mastered\n`;
                    });
                }
            });

            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `math_fact_rumble_results_${currentUser}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Download teacher report as CSV
        downloadReportBtn.addEventListener("click", () => {
            let csvContent = "User,Operation,Group,Fact,Attempts,Correct,Incorrect\n";
            let users = JSON.parse(localStorage.getItem("mathFactRumbleUsers")) || [];

            if (users.length === 0) {
                csvContent += "No users have played yet.\n";
            } else {
                users.forEach(user => {
                    const userMastery = JSON.parse(localStorage.getItem(`mathFactRumbleMastery_${user}`)) || {
                        addition: {},
                        subtraction: {},
                        multiplication: {},
                        division: {}
                    };
                    Object.keys(userMastery).forEach(op => {
                        for (let g = 0; g < 4; g++) {
                            const groupFacts = facts[op].filter(f => f.group === g);
                            const allAttempts = groupFacts.filter(f => userMastery[op][f.q] && userMastery[op][f.q].attempts > 0);
                            allAttempts.forEach(f => {
                                const data = userMastery[op][f.q];
                                const incorrect = data.attempts - data.correct;
                                csvContent += `"${user}",${op},${g + 1} (${g * 3 + 1}-${g * 3 + 3}),"${f.q}",${data.attempts},${data.correct},${incorrect}\n`;
                            });
                        }
                    });
                });
            }

            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "math_fact_rumble_teacher_report.csv";
            a.click();
            URL.revokeObjectURL(url);
        });

        closeSummaryBtn.addEventListener("click", () => {
            masterySummary.style.display = "none";
        });

        closeReportBtn.addEventListener("click", () => {
            teacherReport.style.display = "none";
        });

        // Initial state
        feedbackEl.textContent = "Select or add a user to start!";
        opMasteryEl.textContent = "0/144";
        populateUserDropdown();
        loadUserData(localStorage.getItem("mathFactRumbleCurrentUser"));
    </script>
</body>
</html>
